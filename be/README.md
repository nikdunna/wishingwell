# Wishing Well Backend

FastAPI backend for the Wishing Well topic modeling platform.

## Features

- **Wish Submission**: Submit wishes with OpenAI content moderation
- **Topic Modeling**: Automatic topic discovery using BERTopic
- **Topic Labeling**: Human-readable labels generated by GPT-4o-mini
- **Batch Processing**: Background scheduler for automatic model updates
- **RESTful API**: Clean API design with pagination and filtering

## Tech Stack

- **Framework**: FastAPI
- **Database**: PostgreSQL with SQLAlchemy ORM
- **ML**: BERTopic (sentence-transformers, UMAP, HDBSCAN)
- **AI**: OpenAI API (moderation + topic labeling)
- **Scheduler**: APScheduler for background jobs

## Setup

### 1. Install Dependencies

```bash
pipenv install
```

### 2. Configure Environment

Copy `.env.example` to `.env` and configure:

```bash
cp .env.example .env
```

Required environment variables:
- `DATABASE_URL`: PostgreSQL connection string
- `OPENAI_API_KEY`: Your OpenAI API key

### 3. Initialize Database

```bash
# Create database
createdb wishingwell

# Run migrations
psql -U postgres -d wishingwell -f migrations/001_initial_schema.sql
```

### 4. Run the Server

```bash
pipenv run uvicorn main:app --reload --host 0.0.0.0 --port 8000
```

API will be available at `http://localhost:8000`

Interactive docs: `http://localhost:8000/docs`

## API Endpoints

### Wishes
- `POST /api/v1/wishes` - Submit a new wish
- `GET /api/v1/wishes` - List wishes (paginated)
- `GET /api/v1/wishes/random` - Get a random wish
- `GET /api/v1/wishes/:id` - Get wish details with related wishes
- `DELETE /api/v1/wishes/:id` - Soft delete a wish

### Topics
- `GET /api/v1/topics` - List all topics
- `GET /api/v1/topics/:id` - Get topic with wishes
- `GET /api/v1/topics/:id/wishes` - Get wishes for a topic
- `GET /api/v1/topics/trending` - Get trending topics

### Admin
- `POST /api/v1/admin/model/train` - Trigger model training
- `GET /api/v1/admin/model/status` - Get training status
- `GET /api/v1/admin/model/history` - Get training history
- `GET /api/v1/admin/stats` - Get system statistics
- `POST /api/v1/admin/scheduler/start` - Start background scheduler
- `POST /api/v1/admin/scheduler/stop` - Stop background scheduler

## Architecture

### Directory Structure

```
be/
├── main.py                    # FastAPI application entry point
├── config.py                  # Environment configuration
├── database.py                # Database connection
├── models/                    # SQLAlchemy models
│   ├── wish.py               # Wish model
│   ├── topic.py              # Topic model
│   ├── topic_wish.py         # Junction table
│   ├── model_update.py       # Training history
│   └── rejected_wish.py      # Moderated content log
├── routers/                   # API endpoints
│   ├── wishes.py             # Wish endpoints
│   ├── topics.py             # Topic endpoints
│   └── admin.py              # Admin endpoints
├── services/                  # Business logic
│   ├── content_moderation.py # OpenAI moderation
│   ├── topic_modeling.py     # BERTopic wrapper
│   ├── openai_labeling.py    # GPT-4o-mini labels
│   └── scheduler.py          # Batch updates
└── migrations/                # Database migrations
    └── 001_initial_schema.sql
```

### How It Works

1. **Wish Submission**:
   - User submits wish via `POST /api/v1/wishes`
   - Content moderation checks with OpenAI
   - If safe, wish is stored with `topic_id=NULL`

2. **Batch Processing** (every 60 minutes by default):
   - Scheduler fetches wishes with `topic_id=NULL`
   - BERTopic trains on unassigned wishes
   - Topics are created in database
   - OpenAI generates human-readable labels
   - Wishes are updated with topic assignments

3. **Topic Exploration**:
   - Users browse topics via `GET /api/v1/topics`
   - View wishes within topics
   - See related wishes based on topic

## Development

### Running Tests

```bash
pipenv run pytest
```

### Database Migrations

```bash
# Create a new migration
cat > migrations/002_add_new_column.sql << EOF
ALTER TABLE wishes ADD COLUMN new_column TEXT;
EOF

# Apply migration
psql -U postgres -d wishingwell -f migrations/002_add_new_column.sql
```

### Manual Training

Trigger a manual training run:

```bash
curl -X POST http://localhost:8000/api/v1/admin/model/train
```

Check status:

```bash
curl http://localhost:8000/api/v1/admin/model/status
```

## Configuration

### BERTopic Parameters

- `EMBEDDING_MODEL`: Sentence transformer model (default: `all-MiniLM-L6-v2`)
- `UMAP_N_COMPONENTS`: Dimensionality reduction components (default: 5)
- `HDBSCAN_MIN_CLUSTER_SIZE`: Minimum cluster size (default: 10)

### Scheduler

- `BATCH_UPDATE_INTERVAL_MINUTES`: How often to run batch updates (default: 60)
- `ENABLE_SCHEDULER`: Enable/disable automatic updates (default: true)

## Troubleshooting

### Database Connection Issues

Ensure PostgreSQL is running:
```bash
brew services start postgresql  # macOS
sudo systemctl start postgresql # Linux
```

### OpenAI API Errors

Check your API key is set in `.env`:
```bash
echo $OPENAI_API_KEY
```

### Not Enough Wishes for Training

The minimum cluster size is 10 by default. You need at least 10 unassigned wishes to trigger training. Adjust `HDBSCAN_MIN_CLUSTER_SIZE` in `.env` to lower this threshold.

## License

MIT
